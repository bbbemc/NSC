<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chemical-bonds</title>
    <link rel="stylesheet" href="User.css" />
    <link href="https://fonts.googleapis.com/css2?family=Alegreya:ital,wght@0,400..900;1,400..900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        referrerpolicy="no-referrer" />
    <link rel="icon" type="image/png" href="img/Logoweb.png">
    <style>
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .toast {
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 16px;
            animation: fade-in 0.5s ease-out forwards, fade-out 0.5s ease-in 4.5s forwards;
            transition: transform 0.3s ease;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fade-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>

<body>
    <header>
    </header>

    <main>
        <a id="back-button" class="back-btn">
            <i class="fas fa-arrow-left"></i> back
        </a>
        <div class="container">
            <h1>User Profile</h1>
            <form id="update-profile-form" class="profile-form">
                <div class="profile-image-section">
                    <input type="file" id="profile-image-input" accept="image/*" hidden />
                    <label for="profile-image-input" class="image-wrapper">
                        <img id="profile-image" src="img/default.png" alt="Profile Image" />
                        <div class="overlay">
                            <i class="fas fa-camera"></i>
                        </div>
                    </label>
                </div>

                <div class="field">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" value="" />
                </div>

                <div class="field">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="" readonly />
                </div>

                <div class="field">
                    <label for="current_password">Password (Current)</label>
                    <div class="password-wrapper">
                        <input type="password" id="current_password" name="current_password" />
                        <span class="toggle-password" id="toggle-current">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <label for="new_password">New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="new_password" name="new_password" />
                        <span class="toggle-password" id="toggle-new">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                </div>

                <div class="field">
                    <label for="confirm_password">Confirm New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirm_password" name="confirm_password" />
                        <span class="toggle-password" id="toggle-confirm">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                </div>

                <button type="submit" class="primary-btn">Save Changes</button>
                <div id="status-message"></div>
            </form>
        </div>
        <div id="toast-container"></div>
    </main>

    <script>
        const profileForm = document.getElementById('update-profile-form');
        function showToast(message, isError = false) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (isError) {
                toast.classList.add('error');
            } else {
                toast.classList.add('success');
            }
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        fetch('get_user_info.php')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                } else {
                    // ✅ แก้ไข: เพิ่มบรรทัดนี้เพื่อกำหนดค่าชื่อผู้ใช้
                    document.getElementById('username').value = data.name; // ต้องแน่ใจว่า id ถูกต้อง
                    document.getElementById('email').value = data.email;
                }
            });

        document.getElementById('back-button').addEventListener('click', function () {
            window.history.back();
        });

        const togglePassword = (toggleId, inputId) => {
            const toggle = document.getElementById(toggleId);
            const input = document.getElementById(inputId);
            if (toggle && input) {
                toggle.addEventListener('click', function () {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.querySelector('i').classList.toggle('fa-eye');
                    this.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }
        };

        togglePassword('toggle-current', 'current_password');
        togglePassword('toggle-new', 'new_password');
        togglePassword('toggle-confirm', 'confirm_password');

        document.getElementById('update-profile-form').addEventListener('submit', function (event) {
            event.preventDefault();
            console.log("Form submitted!"); 

            const form = event.target;
            const formData = new FormData();
            // เพิ่มบรรทัดนี้เพื่อส่งชื่อและอีเมลที่แก้ไขแล้ว
            formData.append('name', document.getElementById('username').value);
            formData.append('email', document.getElementById('email').value);
            formData.append('current_password', document.getElementById('current_password').value);
            formData.append('new_password', document.getElementById('new_password').value);
            formData.append('confirm_password', document.getElementById('confirm_password').value);

            // โค้ดส่วนนี้จะจัดการการส่งข้อมูลไปที่ update_profile.php
            fetch('update_profile.php', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server returned an error status: ' + response.status);
                    }
                    return response.json().catch(() => {
                        throw new Error('Invalid JSON response from server');
                    });
                })
                .then(data => {
                    if (data.status === 'success') {
                        showToast(data.message, false);
                        if (data.redirect) {
                            setTimeout(() => {
                                window.location.href = data.redirect;
                            }, 2000);
                        }
                    } else {
                        showToast(data.message, true);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(error.message, true);
                });
        });
    </script>
</body>

</html>